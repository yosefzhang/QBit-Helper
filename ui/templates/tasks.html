{% extends "layout.html" %}

{% block title %}任务 - QBitTorrent Helper{% endblock %}

{% block content %}
<div id="tasks" class="tab-content">
    <!-- 任务结果 -->
    <div class="collapse show" id="taskResultsContent">
        <div id="taskResults" class="mt-3">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>任务执行日志</span>
                    <div>
                        <button id="refreshLogsBtn" class="btn btn-sm btn-outline-primary me-2">
                            <i class="bi bi-arrow-clockwise"></i> 刷新
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#logContentContainer" aria-expanded="false" aria-controls="logContentContainer">
                            展开/收起
                        </button>
                    </div>
                </div>
                <div class="collapse" id="logContentContainer">
                    <div class="card-body p-0">
                        <div id="logContent" class="log-content" style="height: 300px; overflow-y: auto; white-space: pre-wrap; font-family: monospace; font-size: 0.9em; padding: 1rem; background-color: #000; color: #00ff00;">
                            加载中...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 任务内容 -->
    <h3 class="mb-0">任务列表</h3>
    <hr>
    <div class="ms-3 my-3"> 
        <div class="mb-3">
            <button type="button" class="btn btn-primary me-3" data-bs-toggle="modal" data-bs-target="#addTaskModal">新增任务</button>
            <button type="button" class="btn btn-secondary me-3" id="reloadTasksBtn">重载任务</button>
        </div>
        <div id="tasksContainer">
            <!-- 任务将通过JavaScript动态渲染 -->
        </div>
    </div>

<!-- 新增任务模态框 -->
<div class="modal fade" id="addTaskModal" tabindex="-1" aria-labelledby="addTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addTaskModalLabel">新增任务</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addTaskForm">
                    <div class="mb-3">
                        <label for="addTaskName" class="form-label">任务名称</label>
                        <input type="text" class="form-control" id="addTaskName" placeholder="请输入任务名称">
                    </div>
                    <div class="mb-3">
                        <label for="addTaskType" class="form-label">任务类型</label>
                        <select class="form-select" id="addTaskType">
                            <option value="manual">手动任务</option>
                            <option value="auto">自动任务</option>
                        </select>
                    </div>
                    <div class="mb-3" id="addTaskStatusField" style="display: none;">
                        <label for="addTaskStatus" class="form-label">状态</label>
                        <select class="form-select" id="addTaskStatus">
                            <option value="enabled">启用</option>
                            <option value="disabled">禁用</option>
                        </select>
                    </div>
                    <div class="mb-3" id="addCronField" style="display: none;">
                        <label for="addCronExpression" class="form-label">Cron表达式</label>
                        <input type="text" class="form-control" id="addCronExpression" placeholder="请输入 Cron 表达式">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">规则选择</label>
                        <div id="addRulesCheckboxContainer">
                            <!-- 规则复选框将通过JavaScript动态渲染 -->
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="saveAddTaskBtn">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 编辑任务模态框 -->
<div class="modal fade" id="editTaskModal" tabindex="-1" aria-labelledby="editTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editTaskModalLabel">编辑任务</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editTaskForm">
                    <input type="hidden" id="editTaskIndex" value="">
                    <div class="mb-3">
                        <label for="editTaskName" class="form-label">任务名称</label>
                        <input type="text" class="form-control" id="editTaskName" placeholder="请输入任务名称">
                    </div>
                    <div class="mb-3">
                        <label for="editTaskType" class="form-label">任务类型</label>
                        <select class="form-select" id="editTaskType">
                            <option value="manual">手动任务</option>
                            <option value="auto">自动任务</option>
                        </select>
                    </div>
                    <div class="mb-3" id="editTaskStatusField" style="display: none;">
                        <label for="editTaskStatus" class="form-label">状态</label>
                        <select class="form-select" id="editTaskStatus">
                            <option value="enabled">启用</option>
                            <option value="disabled">禁用</option>
                        </select>
                    </div>
                    <div class="mb-3" id="editCronField" style="display: none;">
                        <label for="editCronExpression" class="form-label">Cron表达式</label>
                        <input type="text" class="form-control" id="editCronExpression" placeholder="请输入 Cron 表达式">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">规则选择</label>
                        <div id="editRulesCheckboxContainer">
                            <!-- 规则复选框将通过JavaScript动态渲染 -->
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="saveEditTaskBtn">保存</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/ui/js/scripts.js"></script>
<script>
    // 存储获取到的规则数据
    let fetchedRules = [];
    
    // 从后端获取任务配置
    async function fetchTasks() {
        try {
            console.log('[Frontend Log] Sending GET request to /api/config/get_user_tasks');
            const response = await fetch('/api/config/get_user_tasks');
            console.log(`[Frontend Log] Received response from /api/config/get_user_tasks with status: ${response.status}`);
            const result = await response.json();
            console.log('[Frontend Log] Parsed JSON response:', result);
            
            if (result.success) {
                // 正确处理返回的任务数据结构
                const tasksData = result.data || {};
                
                // 直接从任务数据中获取状态信息，而不是调用单独的API
                const taskStatus = {};
                if (Array.isArray(tasksData.tasks)) {
                    tasksData.tasks.forEach((task, index) => {
                        if (task.task_type === 'auto') {
                            taskStatus[index] = task.status || false;
                        }
                    });
                }
                
                // 将状态信息添加到任务数据中
                tasksData.taskStatus = taskStatus;
                
                // 渲染任务列表
                renderTasks(tasksData.tasks || [], tasksData.taskStatus || {});
            } else {
                // 即使获取失败也显示任务区域，但可能为空
                renderTasks([]);
            }
        } catch (error) {
            console.error('获取任务失败:', error);
            // 即使获取失败也显示任务区域，但可能为空
            renderTasks([]);
        }
    }

    // 渲染任务列表
    function renderTasks(tasks, taskStatus = {}) {
        const tasksContainer = document.getElementById('tasksContainer');
        if (!tasksContainer) return;
        
        // 清空现有内容
        tasksContainer.innerHTML = '';
        
        // 确保tasks是数组
        const tasksArray = Array.isArray(tasks) ? tasks : [];
        
        // 如果没有任务，显示提示信息
        if (tasksArray.length === 0) {
            tasksContainer.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-info">暂无任务配置</div>
                </div>
            `;
            return;
        }
        
        // 创建一个行容器用于栅格布局
        const rowDiv = document.createElement('div');
        rowDiv.className = 'row';
        
        // 遍历任务并创建卡片
        tasksArray.forEach((task, index) => {
            // 从任务对象中直接获取状态，而不是通过参数传递
            const isEnabled = task.task_type === 'auto' ? (task.status || false) : false;
            const taskElement = createTaskElement(task, index, isEnabled);
            rowDiv.appendChild(taskElement);
        });
        
        tasksContainer.appendChild(rowDiv);
    }

    // 创建单个任务元素
    function createTaskElement(task, index) {
        const div = document.createElement('div');
        div.className = 'col-md-6 col-lg-4 mb-3'; // 使用栅格系统限制宽度
        
        // 创建卡片容器
        const cardDiv = document.createElement('div');
        cardDiv.className = 'card h-100';
        
        // 创建卡片头部，根据任务类型设置不同颜色
        const cardHeader = document.createElement('div');
        cardHeader.className = `card-header ${task.task_type === 'manual' ? 'bg-primary' : 'bg-success'} text-white d-flex justify-content-between align-items-center`;
        
        // 头部标题容器
        const headerTitleContainer = document.createElement('div');
        headerTitleContainer.className = 'd-flex align-items-center';
        
        // 头部标题
        const headerTitle = document.createElement('span');
        headerTitle.textContent = task.task_type === 'manual' ? '手动任务' : '自动任务';
        
        headerTitleContainer.appendChild(headerTitle);
        
        // 按钮组
        const buttonGroup = document.createElement('div');
        
        // 根据任务类型确定按钮
        let actionButton;
        if (task.task_type === 'manual') {
            actionButton = document.createElement('button');
            actionButton.className = 'btn btn-sm btn-outline-light me-2 execute-task-btn';
            actionButton.textContent = '执行';
            actionButton.dataset.index = index;
        }
        // 移除自动任务的启用/禁用按钮
        
        const editButton = document.createElement('button');
        editButton.className = 'btn btn-sm btn-outline-light me-2 edit-task-btn';
        editButton.textContent = '编辑';
        editButton.dataset.index = index;
        
        const deleteButton = document.createElement('button');
        deleteButton.className = 'btn btn-sm btn-outline-light delete-task-btn';
        deleteButton.textContent = '删除';
        deleteButton.dataset.index = index;
        
        // 添加按钮到按钮组
        if (actionButton) {
            buttonGroup.appendChild(actionButton);
        }
        buttonGroup.appendChild(editButton);
        buttonGroup.appendChild(deleteButton);
        
        // 组装卡片头部
        cardHeader.appendChild(headerTitleContainer);
        cardHeader.appendChild(buttonGroup);
        
        // 创建表格显示任务信息
        const table = document.createElement('table');
        table.className = 'table mb-0';
        
        const tbody = document.createElement('tbody');
        
        // 任务名称行
        const nameRow = document.createElement('tr');
        nameRow.innerHTML = `<td><strong>任务名称:</strong></td><td>${task.task_name || '未命名任务'}</td>`;
        tbody.appendChild(nameRow);
        
        // Cron表达式行
        const cronRow = document.createElement('tr');
        cronRow.innerHTML = `<td><strong>Cron:</strong></td><td>${task.cron || 'N/A'}</td>`;
        tbody.appendChild(cronRow);
        
        // 解析规则字符串为数组
        const rulesList = task.rules ? task.rules.split('|') : [];
        const rulesDisplay = rulesList.length > 0 ? rulesList.join(', ') : 'N/A';
        
        // 规则行
        const rulesRow = document.createElement('tr');
        rulesRow.innerHTML = `<td><strong>规则:</strong></td><td>${rulesDisplay}</td>`;
        tbody.appendChild(rulesRow);
        
        // 状态行（仅对自动任务显示）
        if (task.task_type === 'auto') {
            const statusRow = document.createElement('tr');
            const statusText = task.status ? '启用' : '禁用';
            const statusClass = task.status ? 'text-success' : 'text-danger';
            statusRow.innerHTML = `<td><strong>状态:</strong></td><td class="${statusClass}">${statusText}</td>`;
            tbody.appendChild(statusRow);
        }
        
        table.appendChild(tbody);
        
        // 创建卡片主体
        const cardBody = document.createElement('div');
        cardBody.className = 'card-body p-0';
        cardBody.appendChild(table);
        
        // 组装卡片
        cardDiv.appendChild(cardHeader);
        cardDiv.appendChild(cardBody);
        
        div.appendChild(cardDiv);
        
        // 绑定执行按钮事件（仅手动任务）
        if (task.task_type === 'manual' && actionButton) {
            actionButton.addEventListener('click', (function(taskCopy, indexCopy) {
                return function() {
                    executeManualTask(indexCopy, taskCopy);
                };
            })(task, index));
        }
        
        // 绑定编辑按钮事件
        editButton.addEventListener('click', (function(taskCopy, indexCopy) {
            return function() {
                editTask(indexCopy, taskCopy);
            };
        })(task, index));
        
        // 绑定删除按钮事件
        deleteButton.addEventListener('click', (function(taskCopy, indexCopy) {
            return function() {
                deleteTask(indexCopy, taskCopy);
            };
        })(task, index));
        
        return div;
    }

    // 启用自动任务
    async function enableAutoTask(index, task, enableButton, disableButton) {
        showToast(`正在启用自动任务: ${task.task_name || '未命名任务'}`, 'info');
        
        // 禁用两个按钮以防止重复点击
        enableButton.disabled = true;
        disableButton.disabled = true;
        enableButton.classList.add('disabled');
        disableButton.classList.add('disabled');
        
        try {
            // 调用后端API启用自动任务
            const response = await fetch('/api/task/enable_auto_task', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    task_index: index
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast(result.message, 'success');
                // 更新按钮状态
                enableButton.disabled = true;
                disableButton.disabled = false;
                enableButton.classList.add('disabled');
                disableButton.classList.remove('disabled');
                // 重新加载任务列表以更新状态显示
                fetchTasks();
            } else {
                // 恢复按钮状态
                enableButton.disabled = false;
                disableButton.disabled = isEnabled;
                enableButton.classList.remove('disabled');
                disableButton.classList.toggle('disabled', !isEnabled);
                showToast(`启用自动任务失败: ${result.message}`, 'danger');
                console.error('启用自动任务失败:', result.message);
            }
        } catch (error) {
            // 恢复按钮状态
            enableButton.disabled = false;
            disableButton.disabled = isEnabled;
            enableButton.classList.remove('disabled');
            disableButton.classList.toggle('disabled', !isEnabled);
            console.error('启用自动任务时发生错误:', error);
            showToast(`启用自动任务时发生错误: ${error.message}`, 'danger');
        }
    }

    // 禁用自动任务
    async function disableAutoTask(index, task, enableButton, disableButton) {
        showToast(`正在禁用自动任务: ${task.task_name || '未命名任务'}`, 'info');
        
        // 禁用两个按钮以防止重复点击
        enableButton.disabled = true;
        disableButton.disabled = true;
        enableButton.classList.add('disabled');
        disableButton.classList.add('disabled');
        
        try {
            // 调用后端API禁用自动任务
            const response = await fetch('/api/task/disable_auto_task', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    task_index: index
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast(result.message, 'success');
                // 更新按钮状态
                enableButton.disabled = false;
                disableButton.disabled = true;
                enableButton.classList.remove('disabled');
                disableButton.classList.add('disabled');
                // 重新加载任务列表以更新状态显示
                fetchTasks();
            } else {
                // 获取当前任务状态以恢复按钮状态
                const taskResponse = await fetch('/api/task/get_auto_task_status');
                const taskResult = await taskResponse.json();
                const isEnabled = taskResult.success ? taskResult.data[index] : false;
                
                // 恢复按钮状态
                enableButton.disabled = !isEnabled;
                disableButton.disabled = isEnabled;
                enableButton.classList.toggle('disabled', isEnabled);
                disableButton.classList.toggle('disabled', !isEnabled);
                showToast(`禁用自动任务失败: ${result.message}`, 'danger');
                console.error('禁用自动任务失败:', result.message);
            }
        } catch (error) {
            // 获取当前任务状态以恢复按钮状态
            try {
                const taskResponse = await fetch('/api/task/get_auto_task_status');
                const taskResult = await taskResponse.json();
                const isEnabled = taskResult.success ? taskResult.data[index] : false;
                
                // 恢复按钮状态
                enableButton.disabled = !isEnabled;
                disableButton.disabled = isEnabled;
                enableButton.classList.toggle('disabled', isEnabled);
                disableButton.classList.toggle('disabled', !isEnabled);
            } catch (e) {
                // 如果恢复状态也失败，则启用两个按钮
                enableButton.disabled = false;
                disableButton.disabled = false;
                enableButton.classList.remove('disabled');
                disableButton.classList.remove('disabled');
            }
            console.error('禁用自动任务时发生错误:', error);
            showToast(`禁用自动任务时发生错误: ${error.message}`, 'danger');
        }
    }

    // 执行手动任务
    async function executeManualTask(index, task) {
        showToast(`正在执行手动任务: ${task.task_name || '未命名任务'}`, 'info');
        
        try {
            // 调用后端API执行手动任务
            const response = await fetch('/api/task/execute_manual_task', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ task_index: index })
            });
            
            const result = await response.json();
            
            if (result.success) {
                console.log('手动任务执行结果:', result.data);
                // 刷新日志以显示最新结果
                await fetchTaskResults();
                showToast(`手动任务 "${task.task_name || '未命名任务'}" 执行完成`, 'success');
            } else {
                showToast(`手动任务执行失败: ${result.message}`, 'danger');
                console.error('手动任务执行失败:', result.message);
            }
        } catch (error) {
            console.error('执行手动任务时发生错误:', error);
            showToast(`执行手动任务时发生错误: ${error.message}`, 'danger');
        }
    }
    
    // 删除任务
    async function deleteTask(index, task) {
        showConfirm(`确定要删除任务 "${task.task_name || '未命名任务'}" 吗？`, async function(confirmed) {
            if (!confirmed) {
                return;
            }
            
            try {
                // 获取当前任务
                console.log('[Frontend Log] Sending GET request to /api/config/get_user_tasks (deleteTask)');
                const response = await fetch('/api/config/get_user_tasks');
                console.log(`[Frontend Log] Received response from /api/config/get_user_tasks (deleteTask) with status: ${response.status}`);
                const result = await response.json();
                console.log('[Frontend Log] Parsed JSON response (deleteTask):', result);
                
                if (result.success) {
                // 正确处理返回的任务数据结构
                const tasksData = result.data || {};
                let tasks = tasksData.tasks || [];
                
                // 确保 tasks 是数组
                if (!Array.isArray(tasks)) {
                    tasks = [];
                }
                
                // 从任务数组中删除指定索引的任务
                tasks.splice(index, 1);
                    
                    // 保存更新后的配置
                    console.log('[Frontend Log] Sending POST request to /api/config/save_user_tasks (deleteTask), Data:', { tasks: tasks });
                    const saveResponse = await fetch('/api/config/save_user_tasks', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ tasks: tasks })
                    });
                    console.log(`[Frontend Log] Received response from /api/config/save_user_tasks (deleteTask) with status: ${saveResponse.status}`);
                    const saveResult = await saveResponse.json();
                    console.log('[Frontend Log] Parsed JSON response (deleteTask):', saveResult);
                    
                    if (saveResult.success) {
                        showToast('任务删除成功');
                        // 重新加载任务
                        fetchTasks();
                    } else {
                        showToast('任务删除失败: ' + saveResult.message, 'danger');
                    }
                } else {
                    showToast('获取任务失败: ' + result.message, 'danger');
                }
            } catch (error) {
                console.error('删除任务失败:', error);
                showToast('删除任务失败: ' + error.message, 'danger');
            }
        });
    }

    // 保存任务（编辑任务）
    async function saveEditTask() {
        // 获取表单数据
        const index = document.getElementById('editTaskIndex').value;
        let taskName = document.getElementById('editTaskName').value;
        const taskType = document.getElementById('editTaskType').value;
        const taskStatus = document.getElementById('editTaskStatus').value;
        const cronExpression = document.getElementById('editCronExpression').value;
        
        // 获取选中的规则
        const checkboxes = document.querySelectorAll('#editRulesCheckboxContainer input[type="checkbox"]:checked');
        const selectedRules = Array.from(checkboxes).map(cb => cb.value);
        const rulesString = selectedRules.join('|');
        
        // 构造任务对象（不包含index）
        const task = {
            'task_name': taskName,
            'task_type': taskType,
            'status': taskStatus === 'enabled', // 将"enabled"/"disabled"转换为true/false
            'cron': cronExpression,
            'rules': rulesString
        };
        
        try {
            // 获取当前任务
            console.log('[Frontend Log] Sending GET request to /api/config/get_user_tasks (saveEditTask)');
            const response = await fetch('/api/config/get_user_tasks');
            console.log(`[Frontend Log] Received response from /api/config/get_user_tasks (saveEditTask) with status: ${response.status}`);
            const result = await response.json();
            console.log('[Frontend Log] Parsed JSON response (saveEditTask):', result);
            
            if (result.success) {
                // 正确处理返回的任务数据结构
                const tasksData = result.data || {};
                let tasks = tasksData.tasks || [];
                
                // 确保 tasks 是数组
                if (!Array.isArray(tasks)) {
                    tasks = [];
                }
                
                // 更新指定索引的任务
                tasks[parseInt(index)] = task;
                
                // 保存配置
                console.log('[Frontend Log] Sending POST request to /api/config/save_user_tasks (saveEditTask), Data:', { tasks: tasks });
                const saveResponse = await fetch('/api/config/save_user_tasks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ tasks: tasks })
                });
                
                console.log(`[Frontend Log] Received response from /api/config/save_user_tasks (saveEditTask) with status: ${saveResponse.status}`);
                const saveResult = await saveResponse.json();
                console.log('[Frontend Log] Parsed JSON response (saveEditTask):', saveResult);
                
                if (saveResult.success) {
                    // 关闭模态框
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editTaskModal'));
                    if (modal) {
                        modal.hide();
                    }
                    // 重新加载任务
                    fetchTasks();
                    showToast('任务保存成功');
                } else {
                    showToast('任务保存失败: ' + saveResult.message, 'danger');
                }
            } else {
                showToast('获取任务失败: ' + result.message, 'danger');
            }
        } catch (error) {
            console.error('保存任务失败:', error);
            showToast('保存任务失败: ' + error.message, 'danger');
        }
    }

    // 保存任务（新增任务）
    async function saveTask() {
        // 获取表单数据
        let taskName = document.getElementById('addTaskName').value;
        const taskType = document.getElementById('addTaskType').value;
        const taskStatus = document.getElementById('addTaskStatus').value;
        const cronExpression = document.getElementById('addCronExpression').value;
        
        // 获取选中的规则
        const checkboxes = document.querySelectorAll('#addRulesCheckboxContainer input[type="checkbox"]:checked');
        const selectedRules = Array.from(checkboxes).map(cb => cb.value);
        const rulesString = selectedRules.join('|');
        
        // 构造任务对象（不包含index）
        const task = {
            'task_name': taskName,
            'task_type': taskType,
            'status': taskStatus === 'enabled', // 将"enabled"/"disabled"转换为true/false
            'cron': cronExpression,
            'rules': rulesString
        };
        
        try {
            // 获取当前任务
            console.log('[Frontend Log] Sending GET request to /api/config/get_user_tasks (saveTask)');
            const response = await fetch('/api/config/get_user_tasks');
            console.log(`[Frontend Log] Received response from /api/config/get_user_tasks (saveTask) with status: ${response.status}`);
            const result = await response.json();
            console.log('[Frontend Log] Parsed JSON response (saveTask):', result);
            
            if (result.success) {
                // 正确处理返回的任务数据结构
                const tasksData = result.data || {};
                const tasks = tasksData.tasks || [];
                
                // 添加新任务
                tasks.push(task);
                
                // 保存配置
                console.log('[Frontend Log] Sending POST request to /api/config/save_user_tasks (saveTask), Data:', { tasks: tasks });
                const saveResponse = await fetch('/api/config/save_user_tasks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ tasks: tasks })
                });
                
                console.log(`[Frontend Log] Received response from /api/config/save_user_tasks (saveTask) with status: ${saveResponse.status}`);
                const saveResult = await saveResponse.json();
                console.log('[Frontend Log] Parsed JSON response (saveTask):', saveResult);
                
                if (saveResult.success) {
                    // 关闭模态框
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addTaskModal'));
                    if (modal) {
                        modal.hide();
                    }
                    // 重新加载任务
                    fetchTasks();
                    showToast('任务保存成功');
                } else {
                    showToast('任务保存失败: ' + saveResult.message, 'danger');
                }
            } else {
                showToast('获取任务失败: ' + result.message, 'danger');
            }
        } catch (error) {
            console.error('保存任务失败:', error);
            showToast('保存任务失败: ' + error.message, 'danger');
        }
    }
    
    // 编辑任务
    function editTask(index, task) {
        // 填充编辑表单
        document.getElementById('editTaskIndex').value = index;
        document.getElementById('editTaskName').value = task.task_name || '';
        document.getElementById('editTaskType').value = task.task_type || 'manual';
        
        // 设置状态选择器的值（仅对自动任务）
        if (task.task_type === 'auto') {
            document.getElementById('editTaskStatus').value = task.status ? 'enabled' : 'disabled';
        }
        
        document.getElementById('editCronExpression').value = task.cron || '';
        
        // 根据任务类型显示或隐藏cron字段和状态字段
        const cronField = document.getElementById('editCronField');
        const statusField = document.getElementById('editTaskStatusField');
        if (task.task_type === 'auto') {
            cronField.style.display = 'block';
            statusField.style.display = 'block';
        } else {
            cronField.style.display = 'none';
            statusField.style.display = 'none';
        }
        
        // 显示模态框
        const modal = new bootstrap.Modal(document.getElementById('editTaskModal'));
        modal.show();
    }
    
    // 获取并显示任务执行结果日志
    async function fetchTaskResults() {
        try {
            const response = await fetch('/api/task/get_task_results');
            const result = await response.json();
            
            if (result.success) {
                const logContent = document.getElementById('logContent');
                if (logContent) {
                    logContent.textContent = result.data || '暂无日志内容';
                    // 滚动到底部
                    logContent.scrollTop = logContent.scrollHeight;
                }
            } else {
                const logContent = document.getElementById('logContent');
                if (logContent) {
                    logContent.textContent = '获取日志失败: ' + result.message;
                }
            }
        } catch (error) {
            console.error('获取任务执行结果失败:', error);
            const logContent = document.getElementById('logContent');
            if (logContent) {
                logContent.textContent = '获取日志失败: ' + error.message;
            }
        }
    }
    
    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
        // 获取任务执行结果日志
        fetchTaskResults();
        
        // 绑定刷新按钮事件
        const refreshBtn = document.getElementById('refreshLogsBtn');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', function() {
                fetchTaskResults();
                showToast('自动任务的执行日志已刷新', 'success');
            });
        }
        
        // 页面加载时获取任务列表
        fetchTasks();
        
        // 绑定任务类型切换事件（新增任务模态框）
        document.getElementById('addTaskType').addEventListener('change', function() {
            const cronField = document.getElementById('addCronField');
            const statusField = document.getElementById('addTaskStatusField');
            if (this.value === 'auto') {
                cronField.style.display = 'block';
                statusField.style.display = 'block';
            } else {
                cronField.style.display = 'none';
                statusField.style.display = 'none';
            }
        });
        
        // 绑定任务类型切换事件（编辑任务模态框）
        document.getElementById('editTaskType').addEventListener('change', function() {
            const cronField = document.getElementById('editCronField');
            const statusField = document.getElementById('editTaskStatusField');
            if (this.value === 'auto') {
                cronField.style.display = 'block';
                statusField.style.display = 'block';
            } else {
                cronField.style.display = 'none';
                statusField.style.display = 'none';
            }
        });
        
        // 绑定保存新增任务按钮事件
        document.getElementById('saveAddTaskBtn').addEventListener('click', saveTask);
        
        // 绑定保存编辑任务按钮事件
        document.getElementById('saveEditTaskBtn').addEventListener('click', saveEditTask);
        
        // 绑定重载任务按钮事件
        document.getElementById('reloadTasksBtn').addEventListener('click', function() {
            fetchTasks();
            // fetchAutoTasks(); // 移除：不再需要触发自动任务状态加载
            showToast('任务列表已重载', 'success');
        });
        
        // 绑定新增任务modal显示事件
        const addTaskModal = document.getElementById('addTaskModal');
        addTaskModal.addEventListener('show.bs.modal', function (event) {
            // 清空表单
            document.getElementById('addTaskForm').reset();
            document.getElementById('addCronField').style.display = 'none';
            document.getElementById('addTaskStatusField').style.display = 'none';
            
            // 获取规则列表并渲染复选框
            fetchRulesForTaskModal('add');
        });
        
        // 绑定编辑任务modal显示事件
        const editTaskModal = document.getElementById('editTaskModal');
        editTaskModal.addEventListener('show.bs.modal', function (event) {
            // 获取规则列表并渲染复选框
            fetchRulesForTaskModal('edit');
        });
    });
    
    // 获取规则列表用于任务模态框
    async function fetchRulesForTaskModal(modalType = 'add') {
        try {
            const response = await fetch('/api/config/get_user_rules');
            const result = await response.json();
            
            if (result.success) {
                fetchedRules = result.data || [];
                if (modalType === 'add') {
                    renderRuleCheckboxes(fetchedRules, 'addRulesCheckboxContainer');
                } else {
                    renderRuleCheckboxes(fetchedRules, 'editRulesCheckboxContainer');
                }
            }
        } catch (error) {
            console.error('获取规则失败:', error);
        }
    }
    
    // 渲染规则复选框
    function renderRuleCheckboxes(rules, containerId = 'addRulesCheckboxContainer') {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        
        if (!rules || rules.length === 0) {
            container.innerHTML = '<p class="text-muted">暂无可用规则</p>';
            return;
        }
        
        rules.forEach((rule, index) => {
            const div = document.createElement('div');
            div.className = 'form-check mb-2';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'form-check-input';
            checkbox.id = `${containerId}Checkbox${index}`;
            checkbox.value = rule.rule_name || `规则${index}`;
            
            const label = document.createElement('label');
            label.className = 'form-check-label';
            label.htmlFor = `${containerId}Checkbox${index}`;
            
            // 显示规则名称和优先级
            label.textContent = (rule.rule_name || `规则${index}`) + ` (优先级: ${rule.priority || 99})`;
            
            div.appendChild(checkbox);
            div.appendChild(label);
            container.appendChild(div);
        });
    }
</script>
{% endblock %}