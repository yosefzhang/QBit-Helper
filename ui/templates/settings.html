{% extends "layout.html" %}

{% block title %}设置 - QBitTorrent Helper{% endblock %}

{% block content %}
<div id="settings" class="tab-content">
    <!-- 设置内容 -->
    <h3 class="mb-0">配置</h3>
    <hr>
    <div class="ms-3 my-3">
                <div class="mb-3">
            <button type="button" class="btn btn-primary me-3" id="saveConfigBtn">保存配置</button>
            <button type="button" class="btn btn-primary me-3" id="reloadConfigBtn">重载配置</button>
        </div>
        <form id="configForm">
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label for="qbHost" class="form-label">QBitTorrent 主机</label>
                    <input type="text" class="form-control" id="qbHost" placeholder="请输入主机地址">
                </div>
                <div class="col-md-3 mb-3">
                    <label for="username" class="form-label">用户名</label>
                    <input type="text" class="form-control" id="username" placeholder="请输入用户名">
                </div>
                <div class="col-md-3 mb-3">
                    <label for="password" class="form-label">密码</label>
                    <input type="password" class="form-control" id="password" placeholder="请输入密码">
                </div>
                <div class="col-md-3 mb-3">
                    <label for="serverKey" class="form-label">Server酱 send key</label>
                    <input type="text" class="form-control" id="serverKey" placeholder="请输入send key">
                </div>
        </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/ui/js/scripts.js"></script>
<script>
    // 页面加载时获取用户配置并填充表单
    document.addEventListener('DOMContentLoaded', function() {
        fetch('/api/config/get_user_config')
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    const config = result.data;
                    
                    // 填充 qBittorrent 配置
                    if (config.qbittorrent) {
                        document.getElementById('qbHost').value = config.qbittorrent.host || '';
                        document.getElementById('username').value = config.qbittorrent.username || '';
                        document.getElementById('password').value = config.qbittorrent.password || '';
                    }
                    
                    // 填充 Server酱 配置
                    if (config.webhook && config.webhook.serverchan) {
                        document.getElementById('serverKey').value = config.webhook.serverchan.sc_key || '';
                    }
                }
            })
            .catch(error => {
                console.error('获取用户配置失败:', error);
            });
    });
    
    // 绑定重载配置按钮事件（设置页面）
    const reloadConfigBtn = document.getElementById('reloadConfigBtn');
    if (reloadConfigBtn) {
        reloadConfigBtn.addEventListener('click', async function() {
            try {
                console.log('发送请求: POST /api/config/reload_config');
                const response = await fetch('/api/config/reload_config', {
                    method: 'POST'
                });
                console.log('请求完成: /api/config/reload_config, 状态:', response.status);
                const result = await response.json();
                console.log('响应数据: /api/config/reload_config, 结果:', result);
                
                if (result.success) {
                    showToast('配置重载成功');
                    // 重新加载页面以获取最新配置
                    location.reload();
                } else {
                    showToast('配置重载失败: ' + result.message, 'danger');
                }
            } catch (error) {
                console.error('重载配置失败:', error);
                showToast('重载配置失败: ' + error.message, 'danger');
            }
        });
    }

    // 绑定保存配置按钮事件（设置页面）
    const saveConfigBtn = document.getElementById('saveConfigBtn');
    if (saveConfigBtn) {
        saveConfigBtn.addEventListener('click', async function() {
            try {
                // 获取表单数据
                const qbHost = document.getElementById('qbHost') ? document.getElementById('qbHost').value : '';
                const username = document.getElementById('username') ? document.getElementById('username').value : '';
                const password = document.getElementById('password') ? document.getElementById('password').value : '';
                const serverKey = document.getElementById('serverKey') ? document.getElementById('serverKey').value : '';
                
                const configData = {
                    qbittorrent: {
                        host: qbHost,
                        username: username,
                        password: password
                    },
                    webhook: {
                        serverchan: {
                            sc_key: serverKey
                        }
                    }
                };
                
                console.log('发送请求: POST /api/config/save_user_config, 数据:', configData);
                const response = await fetch('/api/config/save_user_config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(configData)
                });
                console.log('请求完成: /api/config/save_user_config, 状态:', response.status);
                const result = await response.json();
                console.log('响应数据: /api/config/save_user_config, 结果:', result);
                
                if (result.success) {
                    showToast('配置保存成功');
                } else {
                    showToast('配置保存失败: ' + result.message, 'danger');
                }
            } catch (error) {
                console.error('保存配置失败:', error);
                showToast('保存配置失败: ' + error.message, 'danger');
            }
        });
    }
</script>
{% endblock %}